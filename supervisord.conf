[supervisord]
nodaemon=true
logfile=/dev/stdout
logfile_maxbytes=0
pidfile=/tmp/supervisord.pid

[program:fastapi]
command=uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 2
directory=/app
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=10

# =============================================================================
# CELERY WORKER CONFIGURATION (1000 PDF/hour capacity)
# =============================================================================
# Strategy: Run multiple worker processes with autoscaling
# - concurrency=8: 8 worker processes per pod
# - autoscale=16,4: Scale between 4-16 workers based on load
# - Queues: vision (priority), transcription, enhancement, celery (default)
# 
# For 1000 PDF/hour, deploy 2-3 Celery pods in Coolify
# =============================================================================

[program:celery]
command=celery -A app.celery_app worker --loglevel=INFO --concurrency=8 --autoscale=16,4 -Q vision,transcription,enhancement,celery,high,default -n worker@%%h
directory=/app
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stdout
stderr_logfile_maxbytes=0
redirect_stderr=true
priority=20
# Memory limit (restart if exceeds 1GB)
stopasgroup=true
killasgroup=true
